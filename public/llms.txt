# Branch Tracker API - LLM Reference
# This file describes how AI agents can interact with the Branch Tracker API

## Overview
Branch Tracker is a tool for managing stacked diffs and branch hierarchies across Git projects.
It helps developers track the order and status of branches in a stack, verify ancestry relationships,
and manage PR workflows.

## Base URL
Replace {BASE_URL} with your deployment URL.

The app uses the environment variable NEXT_PUBLIC_PROJECT_URL to configure the base URL.
If not set, it defaults to http://localhost:3000.

Examples:
- Local development: http://localhost:3000
- Production: https://your-app.vercel.app

## Data Model

### Project
A project represents a Git repository being tracked.
Fields:
- id: number (auto-generated)
- name: string (required)
- description: string | null
- masterBranch: string (default: "main") - the base branch for the project
- repoUrl: string | null - URL to the repository
- createdAt: timestamp
- updatedAt: timestamp

### Feature
A feature groups related branches together (e.g., a ticket number like "11627").
Fields:
- id: number (auto-generated)
- projectId: number (required)
- identifier: string (required) - e.g., "11627"
- name: string (required) - e.g., "Agent Eval Feature"
- description: string | null
- color: string (hex color, default: "#6366f1")
- createdAt: timestamp
- updatedAt: timestamp

### Branch
A branch in a stacked diff workflow.
Fields:
- id: number (auto-generated)
- featureId: number (required)
- name: string (required) - full branch name, e.g., "sarvagya-11627-db-infrastructure"
- shortName: string | null - short description
- position: number - order in the stack (1-based)
- status: string - one of: "planned", "active", "pr_raised", "merged", "deprecated", "blocked"
- prUrl: string | null - URL to the pull request
- prNumber: number | null - PR number
- notes: string | null
- isPartOfStack: boolean (default: true) - whether this branch is actively part of the stack
- isPlanned: boolean (default: false) - whether this branch exists only in the tracker (not in git yet)
- createdAt: timestamp
- updatedAt: timestamp

### Plan Mode
Branches can be created in "plan mode" where they exist only in the tracker, not in git.
This allows you to plan your branch stack before creating actual git branches.

To create a planned branch:
- Set isPlanned: true when creating the branch
- The default status will be "planned"

To "realize" a planned branch (mark it as created):
- Set isPlanned: false and status: "active"
- Then create the actual git branch with: git checkout -b {branch-name}

## API Endpoints

### Projects

#### List all projects
GET {BASE_URL}/api/projects

Response:
{
  "data": [
    {
      "id": 1,
      "name": "My Project",
      "description": "...",
      "masterBranch": "main",
      "repoUrl": "https://github.com/...",
      "featureCount": 2,
      "branchCount": 5,
      "createdAt": "...",
      "updatedAt": "..."
    }
  ],
  "error": null
}

#### Create a project
POST {BASE_URL}/api/projects
Content-Type: application/json

Request body:
{
  "name": "My Project",           // required
  "description": "Description",   // optional
  "masterBranch": "main",         // optional, default: "main"
  "repoUrl": "https://..."        // optional
}

Response: { "data": { ...project }, "error": null }

#### Get a project
GET {BASE_URL}/api/projects/{projectId}

Response: { "data": { ...project, featureCount, branchCount }, "error": null }

#### Update a project
PUT {BASE_URL}/api/projects/{projectId}
Content-Type: application/json

Request body (all fields optional):
{
  "name": "New Name",
  "description": "New description",
  "masterBranch": "master",
  "repoUrl": "https://..."
}

Response: { "data": { ...updatedProject }, "error": null }

#### Delete a project
DELETE {BASE_URL}/api/projects/{projectId}

Response: { "data": { "success": true }, "error": null }

### Features

#### List features for a project
GET {BASE_URL}/api/projects/{projectId}/features

Response:
{
  "data": [
    {
      "id": 1,
      "projectId": 1,
      "identifier": "11627",
      "name": "Agent Eval",
      "description": "...",
      "color": "#6366f1",
      "branchCount": 3,
      "activeBranchCount": 3,
      "createdAt": "...",
      "updatedAt": "..."
    }
  ],
  "error": null
}

#### Create a feature
POST {BASE_URL}/api/projects/{projectId}/features
Content-Type: application/json

Request body:
{
  "identifier": "11627",        // required
  "name": "Feature Name",       // required
  "description": "...",         // optional
  "color": "#6366f1"            // optional
}

Response: { "data": { ...feature }, "error": null }

#### Get a feature with branches
GET {BASE_URL}/api/projects/{projectId}/features/{featureId}

Response:
{
  "data": {
    "id": 1,
    "projectId": 1,
    "identifier": "11627",
    "name": "Agent Eval",
    "projectName": "My Project",
    "masterBranch": "main",
    "branches": [
      {
        "id": 1,
        "name": "sarvagya-11627-db-infrastructure",
        "position": 1,
        "status": "pr_raised",
        ...
      }
    ]
  },
  "error": null
}

#### Update a feature
PUT {BASE_URL}/api/projects/{projectId}/features/{featureId}
Content-Type: application/json

Request body (all fields optional):
{
  "identifier": "11628",
  "name": "New Name",
  "description": "...",
  "color": "#22c55e"
}

Response: { "data": { ...updatedFeature }, "error": null }

#### Delete a feature
DELETE {BASE_URL}/api/projects/{projectId}/features/{featureId}

Response: { "data": { "success": true }, "error": null }

### Branches

#### List branches in a feature
GET {BASE_URL}/api/projects/{projectId}/features/{featureId}/branches

Response:
{
  "data": [
    {
      "id": 1,
      "featureId": 1,
      "name": "sarvagya-11627-db-infrastructure",
      "shortName": "db-infrastructure",
      "position": 1,
      "status": "pr_raised",
      "prUrl": "https://github.com/.../pull/123",
      "prNumber": 123,
      "notes": "Sets up database tables",
      "isPartOfStack": true,
      "createdAt": "...",
      "updatedAt": "..."
    }
  ],
  "error": null
}

#### Create a branch
POST {BASE_URL}/api/projects/{projectId}/features/{featureId}/branches
Content-Type: application/json

Request body:
{
  "name": "sarvagya-11627-new-branch",  // required
  "shortName": "new-branch",             // optional
  "status": "active",                    // optional, default: "active"
  "prUrl": "https://...",                // optional
  "prNumber": 123,                       // optional
  "notes": "...",                        // optional
  "isPartOfStack": true                  // optional, default: true
}

Response: { "data": { ...branch }, "error": null }

#### Get a branch
GET {BASE_URL}/api/projects/{projectId}/features/{featureId}/branches/{branchId}

Response: { "data": { ...branch }, "error": null }

#### Update a branch
PUT {BASE_URL}/api/projects/{projectId}/features/{featureId}/branches/{branchId}
Content-Type: application/json

Request body (all fields optional):
{
  "name": "new-branch-name",
  "shortName": "short-name",
  "position": 2,
  "status": "merged",
  "prUrl": "https://...",
  "prNumber": 456,
  "notes": "Updated notes",
  "isPartOfStack": false
}

Response: { "data": { ...updatedBranch }, "error": null }

#### Delete a branch
DELETE {BASE_URL}/api/projects/{projectId}/features/{featureId}/branches/{branchId}

Response: { "data": { "success": true }, "error": null }

### Stack Verification

#### Get stack verification commands
GET {BASE_URL}/api/projects/{projectId}/features/{featureId}/verify-stack

This endpoint returns git commands to verify that each branch in the stack is properly
rebased on its parent branch. The commands are read-only and don't modify any branches.

Response:
{
  "data": {
    "branchCount": 3,
    "branches": [
      { "id": 1, "name": "branch-1", "position": 1, "status": "active" },
      { "id": 2, "name": "branch-2", "position": 2, "status": "pr_raised" },
      { "id": 3, "name": "branch-3", "position": 3, "status": "active" }
    ],
    "baseBranch": "main",
    "oneLiner": "(git merge-base --is-ancestor main branch-1 && echo \"✅ 1. branch-1 ← main\" || echo \"❌ 1. NOT OK\"); ...",
    "script": "#!/bin/bash\n# Stack Verification Script (read-only)\n..."
  },
  "error": null
}

## Common Workflows

### 1. Setting up a new stacked diff workflow
1. Create a project: POST /api/projects
2. Create a feature for your ticket: POST /api/projects/{id}/features
3. Add branches in order: POST /api/projects/{id}/features/{id}/branches (repeat)
4. Update branch statuses as you work: PUT .../branches/{id}

### 2. Checking stack health
1. Get verification commands: GET .../features/{id}/verify-stack
2. Run the returned script in your local repo to check ancestry

### 3. Updating branch status after PR
PUT /api/projects/{projectId}/features/{featureId}/branches/{branchId}
{
  "status": "pr_raised",
  "prUrl": "https://github.com/org/repo/pull/123",
  "prNumber": 123
}

### 4. Marking a branch as merged
PUT /api/projects/{projectId}/features/{featureId}/branches/{branchId}
{
  "status": "merged"
}

### 5. Removing a branch from the stack (without deleting)
PUT /api/projects/{projectId}/features/{featureId}/branches/{branchId}
{
  "isPartOfStack": false,
  "status": "deprecated"
}

### 6. Planning your stack before creating branches
Create planned branches to map out your stack:
POST /api/projects/{projectId}/features/{featureId}/branches
{
  "name": "username-12345-planned-branch",
  "notes": "This branch will handle X",
  "isPlanned": true
}

### 7. Realizing a planned branch (marking it as created in git)
PUT /api/projects/{projectId}/features/{featureId}/branches/{branchId}
{
  "isPlanned": false,
  "status": "active"
}
Then run: git checkout -b {branch-name}

## Branch Status Values
- "planned": Branch exists only in tracker, not created in git yet
- "active": Branch is being actively worked on
- "pr_raised": Pull request has been created
- "merged": Branch has been merged into its parent
- "deprecated": Branch is no longer part of the workflow
- "blocked": Branch is blocked by dependencies or issues

## Error Responses
All endpoints return errors in this format:
{
  "data": null,
  "error": "Error message describing what went wrong"
}

HTTP Status Codes:
- 200: Success
- 201: Created (for POST requests)
- 400: Bad request (invalid input)
- 404: Resource not found
- 500: Server error

## Authentication
Currently, the API does not require authentication. For production deployments,
consider adding authentication middleware.

## Rate Limiting
No rate limiting is currently enforced. Be respectful of server resources.

---

## AI Coding Agent Integration

### For Claude Code, Cursor, Cline, Aider, and similar agents

This section explains how AI coding assistants can integrate with Branch Tracker
to help developers manage their stacked diffs workflow.

### Setup Instructions for Users

1. Deploy Branch Tracker (locally or on Vercel)
2. Set the NEXT_PUBLIC_PROJECT_URL environment variable (or use default localhost:3000)
3. Add this to your agent's context/instructions:

```
I use Branch Tracker to manage my stacked diffs.
API Base URL: http://localhost:3000 (or your deployed URL)
API Reference: {BASE_URL}/llms.txt

When I'm working on branches:
- Check my current branches: GET /api/projects/{projectId}/features/{featureId}
- After creating a new branch, register it in Branch Tracker
- After raising a PR, update the branch status to "pr_raised"
- After merging, update status to "merged"
```

### Claude Code Integration

Add to your CLAUDE.md or project instructions:

```markdown
## Branch Tracking

This project uses Branch Tracker for stacked diffs management.
API: http://localhost:3000

### When creating a new branch:
1. Create the git branch as usual
2. Register it: POST /api/projects/1/features/1/branches
   Body: {"name": "branch-name", "notes": "what this branch does"}

### When raising a PR:
Update the branch: PUT /api/projects/1/features/1/branches/{id}
Body: {"status": "pr_raised", "prUrl": "...", "prNumber": 123}

### To check stack health:
GET /api/projects/1/features/1/verify-stack
Then run the returned script in the terminal.
```

### Cursor Integration

Add to your .cursorrules file:

```
# Branch Tracker Integration
When working with git branches in this project:
1. The project uses stacked diffs tracked at http://localhost:3000
2. After creating branches, register them via the API
3. Keep branch statuses updated (active → pr_raised → merged)
4. Use /verify-stack endpoint to check branch ancestry before rebasing
```

### Cline Integration

Add to your cline_docs/projectContext.md:

```markdown
## Stacked Diffs Workflow

We use Branch Tracker (http://localhost:3000) to manage branch stacks.

Key API endpoints:
- GET /api/projects - list projects
- GET /api/projects/{id}/features/{id} - get feature with all branches
- POST .../branches - register new branch
- PUT .../branches/{id} - update branch status
- GET .../verify-stack - get ancestry verification script

Branch statuses: active, pr_raised, merged, deprecated, blocked
```

### Example Agent Prompts

#### "Register my current branch"
```
The agent should:
1. Run `git branch --show-current` to get branch name
2. POST to /api/projects/{projectId}/features/{featureId}/branches
   with {"name": "<branch-name>"}
```

#### "Update branch status after PR"
```
The agent should:
1. Identify the branch ID from the tracker
2. PUT to /api/projects/{pid}/features/{fid}/branches/{bid}
   with {"status": "pr_raised", "prUrl": "...", "prNumber": ...}
```

#### "Check if my stack is healthy"
```
The agent should:
1. GET /api/projects/{pid}/features/{fid}/verify-stack
2. Execute the returned `oneLiner` or `script` in terminal
3. Report results to user
```

#### "Show me my branch stack"
```
The agent should:
1. GET /api/projects/{pid}/features/{fid}
2. Display branches in order with their statuses
3. Highlight any issues (deprecated branches, blocked, etc.)
```

### MCP (Model Context Protocol) Style Usage

If your agent supports tool use, here are the tool definitions:

```json
{
  "name": "branch_tracker_list_branches",
  "description": "List all branches in a feature stack",
  "parameters": {
    "projectId": "number",
    "featureId": "number"
  }
}
```

```json
{
  "name": "branch_tracker_register_branch",
  "description": "Register a new branch in the tracker",
  "parameters": {
    "projectId": "number",
    "featureId": "number",
    "branchName": "string",
    "notes": "string (optional)"
  }
}
```

```json
{
  "name": "branch_tracker_update_status",
  "description": "Update a branch's status",
  "parameters": {
    "projectId": "number",
    "featureId": "number", 
    "branchId": "number",
    "status": "active | pr_raised | merged | deprecated | blocked",
    "prUrl": "string (optional)",
    "prNumber": "number (optional)"
  }
}
```

```json
{
  "name": "branch_tracker_verify_stack",
  "description": "Get commands to verify branch stack ancestry",
  "parameters": {
    "projectId": "number",
    "featureId": "number"
  }
}
```

### Automated Workflows

#### Git Hook Integration
Add to .git/hooks/post-checkout to auto-register branches:

```bash
#!/bin/bash
BRANCH=$(git branch --show-current)
TRACKER_URL="http://localhost:3000"
PROJECT_ID=1
FEATURE_ID=1

# Check if branch exists in tracker
EXISTS=$(curl -s "$TRACKER_URL/api/projects/$PROJECT_ID/features/$FEATURE_ID/branches" | grep -c "$BRANCH")

if [ "$EXISTS" -eq 0 ]; then
  echo "Registering branch $BRANCH in Branch Tracker..."
  curl -s -X POST "$TRACKER_URL/api/projects/$PROJECT_ID/features/$FEATURE_ID/branches" \
    -H "Content-Type: application/json" \
    -d "{\"name\": \"$BRANCH\"}"
fi
```

#### CI/CD Integration
Update branch status when PR is merged:

```yaml
# GitHub Actions example
on:
  pull_request:
    types: [closed]

jobs:
  update-tracker:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Update Branch Tracker
        run: |
          curl -X PUT "${{ secrets.TRACKER_URL }}/api/projects/1/features/1/branches/${{ env.BRANCH_ID }}" \
            -H "Content-Type: application/json" \
            -d '{"status": "merged"}'
```

### Best Practices for AI Agents

1. **Always check existing state first**: GET the current branches before creating/updating
2. **Use meaningful notes**: Include context about what each branch does
3. **Keep statuses current**: Update status promptly when PR state changes
4. **Verify before rebase**: Always run verify-stack before complex rebases
5. **Handle errors gracefully**: Check for error responses and inform the user

### Troubleshooting

**Branch not found**: The branch might be registered under a different name or feature
**Stack verification fails**: Branches may need rebasing - use the verify-stack output to identify issues
**API returns 500**: Check that the database is accessible and migrations are run

